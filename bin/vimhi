#!/usr/bin/env bash
#
# vimhi
#   view input file with synhi generated by 2html.vim in a paged elinks dump
#
# usage:
#   vimhi [<inputfile>] [<syntax>]
#
# desc:
#   - loads the given file in vim, give as $1 or on stdin
#   - tries to guess syntax if not given, according to vim ftdetect rules
#   - to override filetype auto-detection, give vim filetype as final arg
#
# Scott Mcdermott <scott@smemsh.net>
# https://github.com/smemsh/.vim/
# https://spdx.org/licenses/GPL-2.0

tmprc=`mktemp --suffix=.vim`
tmpfile=`mktemp --suffix=.html`

# file name
if tty -s
then arg=$1; shift; else arg=/dev/stdin; fi

# file type
case $# in
(0) ftline="execute('')";;  # noop (use ftdetect)
(1) ftline="set ft=$1";;
(*) false; exit;;
esac

# vim script
cat << % >| $tmprc
let g:html_no_progress=1
set t_Co=256  " todo: why does vim -T \$TERM not work?
set noswapfile
set runtimepath +=~/.vim/colors/vim-smemsh256
syntax on
colorscheme smemsh256
$ftline
runtime syntax/2html.vim
file $tmpfile
w!
qa!
%

# vim exe
vim -E -s -S $tmprc $arg

elinks \
-dump \
-dump-color-mode 3 \
-no-references \
-eval 'set document.browse.margin_width = 0' \
$tmpfile \
| less
